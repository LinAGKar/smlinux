#!/bin/bash
# This should do everything required to build & install under Ubuntu and update itself.
# Other distros edit config file when prompted to change Linux= to command to get your dependencies.
# Dependencies for many distros are listed on the github FAQ.  Please let me know if incorrect
# or if you have another distro to add.
# 2020-0910-2233

domake(){
#Here We go & music to build to
if ( [ -f /usr/bin/mplayer ] || [ -f /bin/mplayer ] )  && [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/File_Select_64_slowed_down.mp3 ]; then
	if [ -f "$BASEPATH"/"$REPO"/sound/samples/sfx_mario/0C.aiff ]; then
		sh -c 'mplayer -nolirc -really-quiet '"$BASEPATH"/"$REPO"'/sound/samples/sfx_mario/0C.aiff;mplayer -nolirc -really-quiet -volume 40 -loop 0 '${XDG_DATA_HOME:-$HOME/.local/share}'/sm64pc/File_Select_64_slowed_down.mp3&'
	elif [ -f "$BASEPATH"/sm64ex/sound/samples/sfx_mario/0C.aiff ]; then
		sh -c 'mplayer -nolirc -really-quiet '"$BASEPATH"'/sm64ex/sound/samples/sfx_mario/0C.aiff;mplayer -nolirc -really-quiet -volume 40 -loop 0 '${XDG_DATA_HOME:-$HOME/.local/share}'/sm64pc/File_Select_64_slowed_down.mp3&'
	else
		sh -c 'mplayer -nolirc -really-quiet -volume 40 -loop 0 '${XDG_DATA_HOME:-$HOME/.local/share}'/sm64pc/File_Select_64_slowed_down.mp3&'
	fi
fi 
if [ "$TARGET_WEB" = 1 ] && [ "$InstallHD" = 1 ]; then
	sed -i 's/TOTAL_MEMORY=20MB/TOTAL_MEMORY=28MB/g' "$BASEPATH"/"$REPO"/Makefile
fi
if [ "$ANDROID" = 1 ]; then
	exec 2> >(grep -v GtkDialog >&2) # Supress GTK Dialog Warnings
	checkphone
	if [ "$GOTPHONE" = 1 ]; then
		zenity --info --text='\nPhone Detected.  Be sure to grant it debugging permission.\n\nExisting copies must also be removed from device.' --title="Preparing for Android Installation...." --width=440 &disown
	else
		echo "If you want the app installed to your Android device,"
		echo "plug it in now via USB and grant it debugging permission."
		zenity --info --text='\nIf you want the app installed to your Android device, attach it via USB.\n\nGrant it debugging permission before this window disappears.\n\nExisting copies must also be removed from device.' --title="Preparing for Android Installation...." --width=480 &disown
		echo
	fi
fi
if [ "$REPO" = "sm64nx" ]; then
	sed -i 's/-no-pie -lpthread -lzstd/-no-pie -lpthread -lzstd -lstdc++fs/g' "$BASEPATH"/"$REPO"/Makefile
fi
if [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/buildlog.txt ]; then
	mv -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/buildlog.txt ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/buildlog.old
fi
cd "$BASEPATH"/"$REPO"
time make BETTERCAMERA=$BETTERCAMERA NODRAWINGDISTANCE=$NODRAWINGDISTANCE TEXTURE_FIX=$TEXTURE_FIX EXTERNAL_DATA=$EXTERNAL_DATA DISCORDRPC=$DISCORDRPC VERSION=$VERSION RENDER_API=$RENDER_API TARGET_WEB=$TARGET_WEB TEXTSAVES=$TEXTSAVES "$JOBS" LEGACY_RES=$LEGACY_RES DEBUG=$DEBUG IMMEDIATELOAD=$IMMEDIATELOAD > ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/buildlog.txt
if [ "$REPO" = "sm64-port-android-base/app/jni/src" ]; then
	if [ "ARMONLY" = 1 ]; then
		sed -i "s/v8a', 'x86', 'x86_64'/v8a'/g" "$BASEPATH"/"$REPO"/../../build.gradle
	fi
	if [ "$BRANCH" = "sm64ex" ] || [ "$BRANCH" = "sm64ex_nightly" ]; then
		make BETTERCAMERA=$BETTERCAMERA NODRAWINGDISTANCE=$NODRAWINGDISTANCE TEXTURE_FIX=$TEXTURE_FIX EXTERNAL_DATA=$EXTERNAL_DATA DISCORDRPC=$DISCORDRPC VERSION=$VERSION RENDER_API=$RENDER_API TARGET_WEB=$TARGET_WEB TEXTSAVES=$TEXTSAVES "$JOBS" LEGACY_RES=$LEGACY_RES DEBUG=$DEBUG IMMEDIATELOAD=$IMMEDIATELOAD > ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/buildlog.txt
		if [ ! -f "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/sm64."$VERSION".f3dex2* ]; then
			return
		else
			echo
			echo Native Build Succesful.
		fi
		sed -i '/include $(BUILD_SHARED_LIBRARY)/i TEXTURE_FIX ?= 0\nNODRAWINGDISTANCE ?= 0\nBETTERCAMERA ?= 0\nifeq ($(TEXTURE_FIX),1)\n  LOCAL_CFLAGS += -DTEXTURE_FIX\nendif\nifeq ($(NODRAWINGDISTANCE),1)\n  LOCAL_CFLAGS += -DNODRAWINGDISTANCE\nendif\nifeq ($(BETTERCAMERA),1)\n  LOCAL_CFLAGS += -DBETTERCAMERA\nendif\n' "$BASEPATH"/"$REPO"/Android.mk
	fi
	cd "$BASEPATH"/sm64-port-android-base
	checkphone
	echo Android Package Kit build starting...
	killall -q zenity
	if [ "$GOTPHONE" = 1 ]; then
		echo Do not disconnect phone until complete.
		echo
		TOUCH_CONTROLS=$TOUCH_CONTROLS BETTERCAMERA=$BETTERCAMERA NODRAWINGDISTANCE=$NODRAWINGDISTANCE TEXTURE_FIX=$TEXTURE_FIX EXTERNAL_DATA=$EXTERNAL_DATA VERSION=$VERSION TEXTSAVES=$TEXTSAVES ./gradlew installDebug -q
	else
		echo WARNING: Phone not deteced, building without installing.
		echo
		TOUCH_CONTROLS=$TOUCH_CONTROLS BETTERCAMERA=$BETTERCAMERA NODRAWINGDISTANCE=$NODRAWINGDISTANCE TEXTURE_FIX=$TEXTURE_FIX EXTERNAL_DATA=$EXTERNAL_DATA VERSION=$VERSION TEXTSAVES=$TEXTSAVES ./gradlew assembleDebug -q
	fi
	if [ "ARMONLY" = 1 ]; then
		rm app/build.gradle
		git checkout app/build.gradle
	fi
	cd "$BASEPATH"/"$REPO"
	rm Android.mk
	git checkout Android.mk
	if [ "$EXTERNAL_DATA" = 1 ] && [ "$InstallHD" = 1 ]; then
		echo Preparing external data for transfer...
		cd "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res
		if [ -f "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET".old/res/hdbase.zip ]; then
			mv "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET".old/res/hdbase.zip "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res
		else
			unzip hq_sounds_v5.1
		fi
		unzip -n base
		zip -r -0 -u hdbase gfx sound
		ln -s "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res/hdbase.zip "$BASEPATH"/"$REPO"/../../build/outputs/apk/debug/hdbase.zip
		rm -rf sound gfx
	elif [ "$EXTERNAL_DATA" = 1 ]; then
		ln -s "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res/base.zip "$BASEPATH"/"$REPO"/../../build/outputs/apk/debug/base.zip
	fi
	checkphone
	if [ "$GOTPHONE" = 1 ] && [ "$EXTERNAL_DATA" = 1 ]; then
		echo
		echo Pushing external assets to phone...
		if [[ ! `adb shell ls /sdcard/Android/data/com.vdavid003.sm64port 2> /dev/null` ]]; then
			adb shell mkdir /sdcard/Android/data/com.vdavid003.sm64port
			adb shell mkdir /sdcard/Android/data/com.vdavid003.sm64port/files
		fi
		if [ -f "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res/hdbase.zip ]; then
			adb push "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res/hdbase.zip /sdcard/Android/data/com.vdavid003.sm64port/files/
		elif [ "$EXTERNAL_DATA" = 1] && [ -f "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res/base.zip ]; then
			adb push "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res/base.zip /sdcard/Android/data/com.vdavid003.sm64port/files/
		fi
	fi
fi
if [ "$REPO" = "sm64nx" ] || ( [ "$TARGET_WEB" = 1 ] && [ "$InstallHD" = 1 ] ); then
	cd "$BASEPATH"/"$REPO"
	rm Makefile
	git checkout Makefile
fi
if [ -f /usr/bin/mplayer ] && [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/File_Select_64_slowed_down.mp3 ]; then
	killall -q -y1h mplayer
fi
}

androidsdk(){
if [ -f /usr/bin/apt ] && [ ! -d /usr/lib/android-sdk ]; then
	sudo apt install android-sdk -y
fi
if [ ! -f "$BASEPATH"/android-sdk/tools/bin/sdkmanager ]; then
	cd "$BASEPATH"
	wget -q https://dl.google.com/android/repository/commandlinetools-linux-6609375_latest.zip
	unzip -o commandlinetools-linux-6609375_latest -d android-sdk
	rm commandlinetools-linux-6609375_latest.zip
fi
PATH="$BASEPATH"/android-sdk/tools/bin:$PATH
export PATH="$BASEPATH"/android-sdk/tools/bin:$PATH
export ANDROID_HOME="$BASEPATH"/android-sdk
if [ ! -d "$BASEPATH"/android-sdk/licenses ]; then
	yes | sdkmanager --sdk_root=${ANDROID_HOME} --licenses
fi
if [ ! -d "$BASEPATH"/android-sdk/ndk-bundle ]; then
	sdkmanager --install --sdk_root=${ANDROID_HOME} ndk-bundle
fi
}

checkphone(){
adb get-state 1>/dev/null 2>&1 && GOTPHONE=1
}

gcccheck(){
if [ -f /usr/bin/gcc ] || [ -f /bin/gcc ]; then
	if [ `gcc -dumpfullversion -dumpversion` \> 7.99 ]; then
		echo gcc 8 or higher confirmed
		return
	fi
fi 
if [ -f /usr/bin/apt ] || [ -f /bin/apt ]; then		
	echo Attempting to install gcc 9.
	echo | sudo add-apt-repository ppa:ubuntu-toolchain-r/test
	sudo apt install -y g++-9
	sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 80 --slave /usr/bin/g++ g++ /usr/bin/g++-9 --slave /usr/bin/gcov gcov /usr/bin/gcov-9
	if [ `gcc -dumpversion` \> 8.99 ]; then
		echo gcc 9 succesfully installed
		return
	else
		echo Attempting to install gcc 8.
		sudo apt install -y g++-8
		sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-8 80 --slave /usr/bin/g++ g++ /usr/bin/g++-8 --slave /usr/bin/gcov gcov /usr/bin/gcov-8
		if [ `gcc -dumpversion` \> 7.99 ]; then
			echo gcc 8 succesfully installed
			return
		fi
	fi			
fi
echo "ERROR: smlinux doesn't think your C compiler is not new enough for sm64nx."
echo "gcc -dumpfullversion must report 8 or higher."
echo "Please install it then rerun smlinux, or use another repo."
echo "Sometimes its wrong - if you have gcc 8/9/10 and wish to continue, do so."
echo
exec 2> >(grep -v GtkDialog >&2) # Supress GTK Dialog Warnings
if zenity --question --text="sm64nx requires gcc 8 or newer and was not detected.\nDo you wish to continue anyway incase smlinux is reading gcc -dumpversion wrong,\nor abort so you can install it then run smlinux again?" --title "GCC 8 or newer not detected" --ok-label="Abort" --cancel-label="Continue" --width 550; then
	exit
fi
}

vettrom(){
if [ "$VERSION" = "us" ]; then
	HASH=`sha1sum ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64 | grep 9bef1128717f958171a4afac3ed78ee2bb4e86ce`
elif [ "$VERSION" = "jp" ]; then
	HASH=`sha1sum ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64 | grep 8a20a5c83d6ceb0f0506cfc9fa20d8f438cafe51`
elif [ "$VERSION" = "eu" ]; then
	HASH=`sha1sum ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64 | grep 4ac5721683d0e0b6bbb561b58a71740845dceea9`
fi
if [ "$HASH" = "" ]; then
	rm ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64
fi
}

makeconfig(){
if [ ! -d ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc ]; then
	mkdir ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc
fi
echo '# REPO supports sm64-port sm64ex sm64nx render96ex cheaterex
# also sm64-port-android-base & sm64ex-coop (also set BRANCH=coop)
REPO=sm64ex
BRANCH=nightly
InstallHD=1
JOBS=-j
TARGET_WEB=0
# [ sm64ex and its forks ] 
BETTERCAMERA=1
NODRAWINGDISTANCE=1
TEXTURE_FIX=1
EXTERNAL_DATA=1
DISCORDRPC=1
# RENDER_API supports GL (2.1+) or GL_LEGACY (1.1+)
RENDER_API=GL
TEXTSAVES=0
# [ sm64ex-coop ]
IMMEDIATELOAD=1
# [ render96ex ]
LEGACY_RES=1
# [ sm64-port-android-base ]
TOUCH_CONTROLS=1
ARMONLY=1
# [ Advanced Settings ]
# VERSION supports us jp eu (must correspond to rom version)
VERSION=us
DEBUG=0
# Set CONFIG=0 If you do not want to be automatically prompted before building.
CONFIG=1
# BASEPATH must exist and is where folders for each repo will be placed
BASEPATH=$HOME
# Set AutoUpdate=0 to prevent smlinux updating itself automatically when ran
AutoUpdate=1
# Set UpdateHD=0 to prevent smlinux updating addons when rebuilding
UpdateHD=1
# Linux must be set to command appropriate to your distribution. See FAQ.
Linux="sudo apt install -y build-essential git python3 libaudiofile-dev libglew-dev libsdl2-dev binutils libusb-1.0-0-dev libzstd-dev python3-pip p7zip-full mplayer"'> ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/smlinuxcfg.txt
}

loadconfig(){
REPO=sm64pc
TARGET_WEB=0
TEXTSAVES=0
TOUCH_CONTROLS=1
LEGACY_RES=1
BASEPATH=$HOME
ARMONLY=1
DEBUG=0
IMMEDIATELOAD=1
source ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/smlinuxcfg.txt
# the next one just for old config file with branch not 
if [ -z "$BRANCH" ]; then
	BRANCH="$Branch"
fi
if [ "$REPO" = "sm64pc" ] && [ "$BRANCH" = "nightly" ]; then
	REPO=sm64ex
elif [ "$REPO" = "Render96ex" ] || [ "$REPO" = "render96" ] || [ "$REPO" = "Render96" ]; then
	REPO=render96ex
elif [ "$REPO" = "CHEATERex" ] || [ "$REPO" = "CHEATEREX" ]; then
	REPO=cheaterex
elif [ "$BRANCH" = "coop" ]; then
	REPO=sm64ex-coop
fi
if [ "$REPO" = "sm64-port" ]; then
	EXTERNAL_DATA=0
elif [ "$REPO" = "sm64-port-android-base" ]; then
	REPO="sm64-port-android-base/app/jni/src"
	ANDROID=1
	if [ "$BRANCH" = "nightly" ] || [ "$BRANCH" = "sm64ex-nightly" ] || [ "$BRANCH" = "sm64exnightly" ]; then
		BRANCH=sm64ex_nightly
	fi
elif [ "$REPO" = "sm64nx" ]; then
	EXTERNAL_DATA=0
	BRANCH=master
elif [ "$REPO" = "render96ex" ]; then
	EXTERNAL_DATA=1
	TEXTSAVES=1
	SGI=1
elif [ "$REPO" = "sm64ex-coop" ]; then
	NODRAWINGDISTANCE=1
fi
if [ "$JOBS" = "-j" ]; then
	if [ "$REPO" = "sm64nx" ]; then 
		JOBS=-j$(($(nproc) - 1))
		if [ ! -f ~/.smlinuxUpdate ]; then
			echo WARNING: JOBS set to -j$(($(nproc) - 1)) because nuz nx has problems with unlimited.
		fi
	elif [ "$TARGET_WEB" = "1" ]; then
		JOBS=-j`nproc`
		if [ ! -f ~/.smlinuxUpdate ]; then
			echo WARNING: JOBS set to -j`nproc` because nuz emsdk has problems with unlimited. 
		fi
	fi
fi
if [ ! `uname -m` = "x86_64" ] || [ ! "$VERSION" = "us" ]; then
	DISCORDRPC=0
fi
if [ "$TARGET_WEB" = 1 ]; then 
	TARGET=web
	EXTERNAL_DATA=0
	DISCORDRPC=0
else
	TARGET=pc
fi
	if [ "$2" = "--updatehd" ] || [ "$3" = "--updatehd" ] ||[ "$4" = "--updatehd" ] ||[ "$5" = "--updatehd" ]; then
	UpdateHD=1
	InstallHD=1
elif [ "$2" = "--hd" ] || [ "$3" = "--hd" ] ||[ "$4" = "--hd" ] ||[ "$5" = "--hd" ]; then
	UpdateHD=1
	InstallHD=1
fi
if [ "$2" = "--sgi" ] || [ "$3" = "--sgi" ] ||[ "$4" = "--sgi" ] ||[ "$5" = "--sgi" ]; then
	SGI=1
elif [ "$2" = "--SGI" ] || [ "$3" = "--SGI" ] ||[ "$4" = "--SGI" ] ||[ "$5" = "--SGI" ]; then
	SGI=1
fi
if [ "$2" = "--config" ] || [ "$3" = "--config" ] ||[ "$4" = "--config" ] ||[ "$5" = "--config" ]; then
	CONFIG=1
elif [ "$2" = "config" ] || [ "$3" = "config" ] ||[ "$4" = "config" ] ||[ "$5" = "config" ]; then
	CONFIG=1
fi
if [ "$2" = "--depends" ] || [ "$3" = "--depends" ] ||[ "$4" = "--depends" ] ||[ "$5" = "--depends" ]; then
	DEPENDS=1
fi
}

doconfig(){
if(whiptail --title "Build Options" --yesno "$(cat ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/smlinuxcfg.txt)" 28 77 --yes-button "Edit Options" --no-button "Proceed" --defaultno); then
	whiptail --title "READ THIS NOW - IT WILL NOT REAPPEAR AUTOMATICALLY" --msgbox "The config file will open in a text editor.\n\nWhen you exit your editor, installation will continue.\n\nFor most people, default options which include community enhancements are reccommended.\n\nIf you mess up the config file, delete\n${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/smlinuxcfg.txt \nand it will be recreated." 16 60
editconfig	
fi
}

editconfig(){
echo Looking for a text editor...
EDITORS=kate:epad:gedit:notepadqq:bluefish:geany:lime:medit:leafpad:nano:pico:micro:jed:emacs:vim:vi
IFS=":"
for editor in $EDITORS; do
	$editor ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/smlinuxcfg.txt
	if [ $? -eq 0 ]; then
		echo found $editor
		return
	fi
done
}

loademsdk(){
if [ ! -d "$BASEPATH"/emsdk ]; then
	cd "$BASEPATH"
	git clone https://github.com/emscripten-core/emsdk
	cd emsdk
	./emsdk install latest
	./emsdk activate latest
fi
source "$BASEPATH"/emsdk/emsdk_env.sh
}

prepnx(){
mkdir "$BASEPATH"/"$REPO"/build
mkdir "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"
mkdir "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs
ln -s ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64.sav "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/sm64.sav 
ln -s ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64.log "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/sm64.log 
ln -s ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/conf.bin "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/conf.bin
ln -s ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/gamepad1.bindings.json "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/gamepad1.bindings.json
ln -s ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/keyboard1.bindings.json "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/keyboard1.bindings.json
ln -s ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64 "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/baserom."$VERSION".z64
cd "$BASEPATH"/"$REPO"/tools
make "$JOBS"
cd "$BASEPATH"/"$REPO"/import
echo Extracting Assets from ROM...
python3 extract_assets.py
python3 ../scripts/pak.py --source . --output "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/'!!base.pak'
if [ ! -f "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/'!!base.pak' ]; then
	echo 
	echo Unable to extract and pak ROM.
	echo "smlinux exiting incomplete.  Contact #help-desk for support."
	echo
	xdg-open https://discord.gg/Ub6YHRm &disown
	exit
fi
}

dohd(){ 
if [ "$REPO" = "sm64nx" ]; then 
	echo Getting Add-on Paks
	if [ ! -d "$BASEPATH"/"$REPO"/build ] ; then mkdir "$BASEPATH"/"$REPO"/build
	fi
	if [ ! -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET" ] ; then mkdir "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"
	fi
	if [ ! -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs ] ; then mkdir "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs
	fi
	if [ ! -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"Cleaner Aesthetics" ]; then
		mkdir "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"Cleaner Aesthetics"
		cd "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"Cleaner Aesthetics"
		wget -q https://cdn.discordapp.com/attachments/730416836780490752/730430152957362191/cleaner.pak
	fi
	if [ ! -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"HD Mario . Bowser" ]; then
		mkdir "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"HD Mario . Bowser"
		cd "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"HD Mario . Bowser"
		wget -q https://cdn.discordapp.com/attachments/730416836780490752/730425308989227158/arredondo.pak
	fi
	if [ ! -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"~SGI Models" ]; then
		mkdir "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"~SGI Models"
		cd "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"~SGI Models"
		wget -q https://cdn.discordapp.com/attachments/730416836780490752/730645970693652591/sgi1.2.pak
	fi
	if [ ! -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"~OWO Mod" ]; then
		mkdir "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"~OWO Mod"
		cd "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"~OWO Mod"
		wget -q https://cdn.discordapp.com/attachments/730416836780490752/730420038024036362/owo.pak
	fi
	if [ ! -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"~HD Luigi" ]; then
		mkdir "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"~HD Luigi"
		cd "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"~HD Luigi"
		wget -q https://cdn.discordapp.com/attachments/730416836780490752/730425786452017222/luigi.pak
	fi
	if [ ! -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"~NES Retro" ]; then
		mkdir "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"~NES Retro"
		cd "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs/"~NES Retro"
		wget -q https://cdn.discordapp.com/attachments/730416836780490752/730431589749620736/nes.pak
	fi
else
	if [ "$EXTERNAL_DATA" = 1 ] ; then
		if [ ! -d "$BASEPATH"/"$REPO"/build ] ; then 
			mkdir "$BASEPATH"/"$REPO"/build
		fi
		if [ ! -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET" ] ; then 
			mkdir "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"
		fi
		if [ -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res/.git ] ; then
			echo Updating Textures...
			cd "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res
			git pull
		elif [  -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res ] ; then
			mv "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res.old
			echo Downloading Cleaner Aesthetics Textures...
			git clone --single-branch https://github.com/CrashCrod/Cleaner-Aesthetics.git "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res
			mv -n "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res.old/* "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res
		elif [  ! -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res ] ; then
			if [ "$REPO" = "render96ex" ]; then
				echo Downloading Render96 Textures... 
				git clone --single-branch https://github.com/pokeheadroom/RENDER96-HD-TEXTURE-PACK "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res
			else
				echo Downloading Cleaner Aesthetics Textures...
				git clone --single-branch https://github.com/CrashCrod/Cleaner-Aesthetics "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res
			fi
		fi
		if [ -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res/gfx/textures/skyboxes ]; then
			rm -rf "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res/gfx/textures/skyboxes
		fi
		if [ -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res/screenshots ]; then
			rm -rf "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res/screenshots
		fi
		if [ ! -f "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res/hq_sounds_v5.1.zip ]; then
			cd "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res	
			echo Getting High Quality Sounds...
			wget -q https://github.com/MapAnon/sm64-pc-hq-sounds/releases/download/5.1/hq_sounds_v5.1.zip
		fi
	fi
	if  [ "$SGI" = 1 ]; then
		dosgi
	elif  [ ! "$SGI" = 1 ] && [ ! -f "$BASEPATH"/"$REPO"/enhancements/Old_School_HD_SGI_Base_Models_V1.3_Refresh_11.7z ] && [ ! -f "$BASEPATH"/"$REPO"/enhancements/RENDER96_V1* ] ; then
		if [ ! -f "$BASEPATH"/"$REPO"/enhancements/hd_bowser.rar ]; then
			cd "$BASEPATH"/"$REPO"/enhancements
			if [ ! "$REPO" = "sm64ex-coop" ]; then
				wget -q https://cdn.discordapp.com/attachments/716459185230970880/719758031990030427/Old_School_HD_Mario_Model.zip 
			fi
			wget -q https://cdn.discordapp.com/attachments/716459185230970880/718990046442684456/hd_bowser.rar	
			cd "$BASEPATH"/"$REPO"	
			cp -Rn actors actors.bak
			if [ ! "$REPO" = "sm64ex-coop" ]; then
				echo Extracting HD Mario...
				unzip -o enhancements/Old_School_HD_Mario_Model 
			fi
			echo Extracing HD Bowser...
			unrar x -o+ enhancements/hd_bowser
		fi
		if [ ! -f "$BASEPATH"/"$REPO"/enhancements/3d_coin_v2*.patch ]; then
			if [ "$REPO" = "sm64pc" ] || ([ "$REPO" = "sm64ex" ] && [ "$BRANCH" = "master" ]); then
				cd "$BASEPATH"/"$REPO"/enhancements
				wget -q https://cdn.discordapp.com/attachments/716459185230970880/718674249631662120/3d_coin_v2.patch
			elif [ "$REPO" = "sm64ex" ] || [ "$REPO" = "sm64-port" ] || [ "$REPO" = "cheaterex" ]; then
				cd "$BASEPATH"/"$REPO"/enhancements
				wget -q https://cdn.discordapp.com/attachments/721806706547490868/725041183700680807/3d_coin_v2_nightly.patch
			fi
			if [ -f "$BASEPATH"/"$REPO"/enhancements/3d_coin_v2*.patch ]; then
				cd "$BASEPATH"/"$REPO"
				echo Applying 3D Coin Patch...
				git apply enhancements/3d_coin_v2*.patch
			fi
		fi
	fi
	if [ `uname -m` = "x86_64" ] && [ -f "$BASEPATH"/"$REPO"/enhancements/60fps*.patch ] && (!( [ "$TARGET_WEB" = 1 ] || [ "$SGI" = 1 ] || [ "REPO" = "sm64ex-coop" ] )); then
		cd "$BASEPATH"/"$REPO"
		if [ ! -f "$BASEPATH"/"$REPO"/enhancements/60fps ]; then
			echo Applying 60fps patch...
			git apply enhancements/60fps*.patch
			touch enhancements/60fps
			if [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64config.txt ] && [ -f "$BASEPATH"/"$REPO"/enhancements/60fps ]; then
				echo Enabling Vsync...
				sed -i 's/vsync false/vsync true/g' ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64config.txt
			fi
		fi
	fi
fi
}

dosgi(){
if  [ "$TARGET_WEB" = 1 ] || [ "$EXTERNAL_DATA" = 0 ]; then
	if(whiptail --title "SGI Model Warning" --yesno "SGI Model Pack V1.3 might not work on anything besides REPO=sm64ex BRANCH=nightly and TARGET_WEB=0.\nExternal Data is also Required." 10 50 --yes-button "Continue Anyway" --no-button "Cancel" --defaultno); then
		echo WARNING: sgi 1.3 might not work on anything besides sm64ex-nightly
		echo Proceeding anyway, but it may not be succesful.
	else
		exit
	fi
fi
if [ -f "$BASEPATH"/"$REPO"/enhancements/RENDER96_V1* ] || [ -f "$BASEPATH"/"$REPO"/enhancements/Old_School_HD_SGI_Base_Models_V1.3_Refresh_11.7z ]; then 
	echo Render96 Models Already Installed...
	return
fi
if [ ! -f /usr/bin/7z ]; then 
	if [ ! -f /bin/7z ]; then
		echo "SGI Models comes as a 7z file but you don't have 7z to extract it."
		if [ -f /usr/bin/apt ]; then
			echo Please provide your password to install...
			sudo apt install p7zip-full
		else
			echo This script checks for /usr/bin/7z.  The ubuntu package is called p7zip.
			echo Please install whatever package gets you 7z and run smlinux again.
			echo Also please let author know what package and distro so I can add it
			echo to depdencency list so others avoid this message.  
			exit
		fi
	fi
fi
if [ -d "$BASEPATH"/"$REPO"/actors.bak ]; then
	echo Restoring default actors...
	cd "$BASEPATH"/"$REPO"/enhancements
	rm -rf "$BASEPATH"/"$REPO"/actors
	mv "$BASEPATH"/"$REPO"/actors.bak "$BASEPATH"/"$REPO"/actors
	rm hd_bowser.rar Old_School_HD_Mario_Model.zip
fi
if [ -f "$BASEPATH"/"$REPO"/enhancements/3d_coin*.patch ]; then
	echo Removing 3D coins...
	cd "$BASEPATH"/"$REPO"
	git apply -R enhancements/3d_coin*.patch
	rm enhancements/3d_coin*.patch
fi
if [ -f "$BASEPATH"/"$REPO"/enhancements/60fps ]; then
	cd "$BASEPATH"/"$REPO"
	git apply -R enhancements/60fps*.patch
	rm enhancements/60fps
	if [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64config.txt ]; then
		sed -i 's/vsync true/vsync false/g' ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64config.txt
	fi
fi
if [ "$REPO" = "render96ex" ] ; then
	cd "$BASEPATH"/"$REPO"/enhancements 
	wget -q https://cdn.discordapp.com/attachments/730551213376143431/745382037560492132/RENDER96_V1.4.2_Luigi_Fixed_Sound.zip
	SGIFILE=RENDER96_V1.4.2_Luigi_Fixed_Sound.zip
else
	cd "$BASEPATH"/"$REPO"/enhancements
	wget -q https://cdn.discordapp.com/attachments/727722992137666573/745038574918828112/RENDER96_V1.3.7z
	SGIFILE=RENDER96_V1.3.7z
fi
if  [ -f "$BASEPATH"/"$REPO"/enhancements/CHEATER*.patch ]; then
	echo Removing cheater...
	cd "$BASEPATH"/"$REPO"
	git apply -R enhancements/CHEATER*.patch
	rm enhancements/CHEATER*
fi
cd "$BASEPATH"/"$REPO"
echo Applying Render96 SGI Models...
7z x enhancements/"$SGIFILE" -aoa 
}
	
scriptUpdate(){
if [ ! -f ~/.smlinuxUpdate ]; then 
	if [ ! -f "${MAPFILE[0]}"/smlinux ] || [ ! -d ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/.git] ; then
		echo Installing Script... 		
		if [ -d ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc ]; then
			if [ -d ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc.baq ]; then
				rm -rf ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc.baq
			fi
			mv -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc.baq
		fi
		git clone --single-branch https://github.com/enigma9o7/smlinux.git ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc
		if [ -d ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc.baq ]; then
			cp -Rn ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc.baq/* ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/
			rm -rf ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc.baq
		fi
		if [ ! -d ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/.git] ; then
			echo ERROR: Cannot connect to github. Run without AutoUpdate enabled.  
			echo smlinux exiting incomplete.
			exit
		fi
		touch ~/.smlinuxUpdate
		mv ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/smlinux "${MAPFILE[0]}"/
		if [ ! -f "${MAPFILE[0]}"/smlinux ]; then
			echo WARNING: Could not write to first path directory.  Creating $HOME/bin.
			touch "$BASEPATH"/.smlinuxNopath
			mkdir $HOME/bin
			export PATH=$HOME/bin:$PATH
			mapfile -t -d: <<<"$PATH"
			mv -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/smlinux "${MAPFILE[0]}"/
			if [ ! -f "${MAPFILE[0]}"/smlinux ]; then
				echo ERROR - Could not add to path.  Run without AutoUpdate enabled.
				echo smlinux exiting incomplete.
				exit
			fi
		fi
		chmod +x "${MAPFILE[0]}"/smlinux
		cd "$LAUNCH_DIR"
		exec smlinux "$@"
	else
		cd ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc
		git fetch
		if [ "$(git diff HEAD origin/HEAD -- smlinux)" != "" ]; then
			git merge
			if [ ! -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/smlinux ]; then
				echo "ERROR: Script Update Unsuccesful."
				echo "Try #help-desk if script udpates continue to fail"
			else
				echo 'mapfile -t -d: <<<"$PATH"
				mv -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/smlinux "${MAPFILE[0]}"/
				if [ ! -f "${MAPFILE[0]}"/smlinux ]; then
					echo WARNING: Could not write to first path directory.  Creating $HOME/bin.
					touch "$BASEPATH"/.smlinuxNopath
					mkdir $HOME/bin
					export PATH=$HOME/bin:$PATH
					mapfile -t -d: <<<"$PATH"
					mv -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/smlinux "${MAPFILE[0]}"/
					if [ ! -f "${MAPFILE[0]}"/smlinux ]; then
						echo ERROR - Could not add to path.  Run without AutoUpdate enabled.
						exit
					fi
				fi
				chmod +x "${MAPFILE[0]}"/smlinux
				if [ -f "$BASEPATH"/Downloads/smlinux ]; then mv -f "$BASEPATH"/Downloads/smlinux "$BASEPATH"/Downloads/smlinux.old.backup
				fi
				if [ -f "$BASEPATH"/Downloads/smlinux.sh ]; then mv -f "$BASEPATH"/Downloads/smlinux.sh "$BASEPATH"/Downloads/smlinux.old.backup
				fi
				if [ -f "$BASEPATH"/Downloads/smlinux.txt ]; then mv -f "$BASEPATH"/Downloads/smlinux.txt "$BASEPATH"/Downloads/smlinux.old.backup
				fi	
				exec smlinux "$@"' > ~/.smlinuxUpdate
				chmod +x ~/.smlinuxUpdate
				cd "$LAUNCH_DIR"
				exec ~/.smlinuxUpdate "$@"
			fi
		else    
			echo Already up to date.
		fi
	fi
fi
}

makedesktop(){
if [ ! -d ${XDG_DATA_HOME:-$HOME/.local/share}/icons ]; then 
	mkdir ${XDG_DATA_HOME:-$HOME/.local/share}/icons
fi
if [ ! -d ${XDG_DATA_HOME:-$HOME/.local/share}/applications ]; then 
	mkdir ${XDG_DATA_HOME:-$HOME/.local/share}/applications
fi
if [ ! -f ${XDG_DATA_HOME:-$HOME/.local/share}/icons/"$REPO".* ]; then
	echo Getting Icon...
	if [ "$REPO" = "sm64ex" ]; then
		wget -q https://cdn.discordapp.com/attachments/711253314855108629/712146686834638890/sm64.png
		mv sm64.png ${XDG_DATA_HOME:-$HOME/.local/share}/icons/"$REPO".png
	elif [ "$REPO" = "sm64nx" ]; then 
		wget -q https://cdn.discordapp.com/attachments/711253314855108629/719215654837682226/Super_Mario_64.png
		mv Super_Mario_64.png ${XDG_DATA_HOME:-$HOME/.local/share}/icons/"$REPO".png
	elif [ "$REPO" = "render96ex" ]; then 
		mv ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/r96-icon.png ${XDG_DATA_HOME:-$HOME/.local/share}/icons/"$REPO".png
	elif [ "$REPO" = "cheaterex" ]; then 
		wget -q https://cdn.discordapp.com/attachments/710334795674288139/745150550382870548/bowser.png
		mv bowser.png ${XDG_DATA_HOME:-$HOME/.local/share}/icons/"$REPO".png
	elif [ "$REPO" = "sm64-port" ]; then 
		wget -q https://cdn.discordapp.com/attachments/710334795674288139/745156574334550096/staricon.png
		mv staricon.png ${XDG_DATA_HOME:-$HOME/.local/share}/icons/"$REPO".png
	elif [ "$REPO" = "sm64ex-coop" ]; then 
		wget -q https://cdn.discordapp.com/attachments/710334795674288139/741732375074963556/luigihudicon.png
		mv luigihudicon.png ${XDG_DATA_HOME:-$HOME/.local/share}/icons/"$REPO".png
	elif [ -f "$BASEPATH"/"$REPO"/textures/segment2/segment2.05A00.rgba16.png ]; then
		cp "$BASEPATH"/"$REPO"/textures/segment2/segment2.05A00.rgba16.png ${XDG_DATA_HOME:-$HOME/.local/share}/icons/"$REPO".png
		echo 16x16 image from ROM used.  Reccommend replacing ${XDG_DATA_HOME:-$HOME/.local/share}/icons/"$REPO".png
	else 
		echo WARNING: No icon found. 
		echo Reccommend creating ${XDG_DATA_HOME:-$HOME/.local/share}/icons/"$REPO".png
	fi	
else
	echo Icon already exists...
fi
if [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/cooplauncher ] && [ "$REPO" = "sm64ex-coop" ] && [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop ]; then
	rm ${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
	rm ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/cooplauncher
fi

if [ ! -f ${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop ]; then
	echo '[Desktop Entry]
Encoding=UTF-8
Type=Application
StartupNotify=false
Categories=Game;'>${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
echo Icon=${XDG_DATA_HOME:-$HOME/.local/share}/icons/"$REPO".png >>${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
echo Name=Super Mario 64 \("$REPO"\) >>${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
	if [ "$REPO" = "sm64pc" ] || [ "$REPO" = "sm64ex" ] ; then
		echo Path="$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET" >>${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
		echo Exec=\""$BASEPATH"\"/"$REPO"/build/"$VERSION"_"$TARGET"/sm64."$VERSION".f3dex2e --cheats>>${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
	elif [ "$REPO" = "render96ex" ]; then
		echo Path="$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET" >>${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
		echo Exec=\""$BASEPATH"\"/"$REPO"/build/"$VERSION"_"$TARGET"/sm64."$VERSION".f3dex2e --cheats --savepath ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO">>${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
	elif [ "$REPO" = "cheaterex" ]; then
		echo Path="$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET" >>${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
		echo Exec=\""$BASEPATH"\"/"$REPO"/build/"$VERSION"_"$TARGET"/sm64."$VERSION".f3dex2e --cheats --savepath ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO">>${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
	elif [ "$REPO" = "sm64ex-coop" ]; then
		echo Path="$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET" >>${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
		echo 'Exec=zenity --info --text="Your IP Address is `curl ifconfig.me`  \nServer must provide this address to host." --title="IP Address" --width 300&/home/bodhi/sm64ex-coop/build/us_pc/sm64.us.f3dex2e --cheats --skip-intro --savepath '${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO">>${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
	elif [ "$REPO" = "sm64-port" ]; then
		echo Path=${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO" >>${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
		printf "Exec=sh -c \"" >>${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
		echo \""$BASEPATH"\"/"$REPO"/build/"$VERSION"_"$TARGET"/sm64."$VERSION".f3dex2e';echo'\" >>${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
	else
		echo Path="$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET" >>${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
		echo Exec=\""$BASEPATH"\"/"$REPO"/build/"$VERSION"_"$TARGET"/sm64."$VERSION".f3dex2e>>${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop
	fi
	if [ -d ${XDG_DESKTOP_DIR:-$HOME/Desktop} ]; then
		cp ${XDG_DATA_HOME:-$HOME/.local/share}/applications/"$REPO".desktop ${XDG_DESKTOP_DIR:-$HOME/Desktop}
	fi
else
	echo Menu entry desktop file already exists...
fi
}
rungame(){
if [ "$TARGET_WEB"  = 1 ]; then 
	cd "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"
	ln -s sm64.us.f3dex2e.html index.html
	python3 -m http.server 8100 &
	if [ -f /usr/bin/firefox ]; then
		firefox --new-window http://localhost:8100&disown
	else
		xdg-open http://localhost:8100&disown
	fi
elif [ "$ANDROID"  = 1 ] ; then
	if [ "$GOTPHONE" = 1 ]; then
		adb shell am start -n com.vdavid003.sm64port/.sm64portActivity
		if [ "$EXTERNAL_DATA" = 1 ]; then
			echo 
			echo When SM64 is launched screen will appear blank while external assets are loaded.
			echo Just wait...
		fi
	elif [ "$EXTERNAL_DATA" = 1 ]; then
		zenity --info --text="Your Android device was not detected so app could not be installed.\nYou must put base assets (base.zip or hdbase.zip) into\nInternal Storage/Android/data/com.vdavid003.sm64port/files\nThis folder will be created when you launch the apk." --title="Transfer External Resources!" --width=470
		echo
		echo "Your Android device was not detected so app could not be installed."
		echo "You must put base assets (base.zip or hdbase.zip) into"
		echo "Internal Storage/Android/data/com.vdavid003.sm64port/files"
		echo 
	fi
	xdg-open "$BASEPATH"/"$REPO"/../../build/outputs/apk/debug &disown
elif [ "$REPO"  = "sm64ex-coop" ] ; then
	cd "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"
	./sm64.us.f3dex2e --server 27015 --cheats --savepath ${XDG_DATA_HOME:-$HOME/.local/share}/sm64ex-coop --skip-intro --configfile sm64config.server-local.txt &disown
	./sm64.us.f3dex2e --client 127.0.0.1 27015 --cheats --savepath ${XDG_DATA_HOME:-$HOME/.local/share}/sm64ex-coop --skip-intro &disown
else 
	gtk-launch "$REPO"&disown
fi
}

####################################### The Beginning ########################################

# Make sure folders and installer config file exist, if not create them.

LAUNCH_DIR=$(pwd)
mapfile -t -d: <<<"$PATH"
if [ ! -d $HOME/.local ]; then 
	mkdir $HOME/.local
fi
if [ ! -d ${XDG_DATA_HOME:-$HOME/.local/share} ]; then 
	mkdir ${XDG_DATA_HOME:-$HOME/.local/share}
fi
if [ ! -f ~/.smlinuxUpdate ]; then
	if [ "$1" = "config" ]; then
		editconfig
		echo "Thank you for editing your smlinux config file." 
		echo "Do you know how to write a GUI to edit it?"
		echo "If so I would love to use it as a front end."
		echo
		exit
	elif [ "$1" = "reset" ]; then
		rm ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/smlinuxcfg.txt
		makeconfig
		echo
		echo smlinux configuration file has been reset to default.
		echo
		exit
	elif [ ! -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/smlinuxcfg.txt ]; then
		echo smlinux configuration file not found, so making a new one...
		makeconfig
		doconfig
	else
		loadconfig "$@"
		if [ "$CONFIG" = 1 ] && (!( [ "$1" = "--help" ] || [ "$1" = "-help" ] || [ "$1" = "help" ] )); then
			doconfig
		fi
	fi
	echo Loading ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/smlinuxcfg.txt...
	loadconfig "$@"
	#Play a sound clip for no reason - thank you for playing my game.
	if [ -f /usr/bin/mplayer ] || [ -f /bin/mplayer ]; then
		if [ -f "$BASEPATH"/sm64pc/sound/samples/sfx_mario_peach/0D.aiff ]; then
			sh -c 'mplayer -nolirc -really-quiet "$BASEPATH"/sm64pc/sound/samples/sfx_mario_peach/0D.aiff&'
		elif [ -f "$BASEPATH"/sm64ex/sound/samples/sfx_mario_peach/0D.aiff ]; then
			sh -c 'mplayer -nolirc -really-quiet "$BASEPATH"/sm64ex/sound/samples/sfx_mario_peach/0D.aiff&'
		elif [ -f "$BASEPATH"/render96ex/sound/samples/sfx_mario_peach/0D.aiff ]; then
			sh -c 'mplayer -nolirc -really-quiet "$BASEPATH"/render96ex/sound/samples/sfx_mario_peach/0D.aiff&'
		elif [ -f "$BASEPATH"/sm64-port/sound/samples/sfx_mario_peach/0D.aiff ]; then
			sh -c 'mplayer -nolirc -really-quiet "$BASEPATH"/sm64-port/sound/samples/sfx_mario_peach/0D.aiff&'
		fi
	fi
	if [ ! -d ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO" ] && [ ! "$ANDROID" = 1 ]; then
		echo Creating ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO" folder for game save and configuration.
		mkdir ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"
	fi
	echo Verifying ROM...
	if [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64 ]; then
		if [ ! -f "$BASEPATH"/"$REPO"/baserom."$VERSION".z64 ]  && [ -d "$BASEPATH"/"$REPO" ]; then
			ln -s ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64 "$BASEPATH"/"$REPO"/baserom."$VERSION".z64
		fi
		echo ROM Available.
	else
		cd "$LAUNCH_DIR"
		if [ -f "$1" ]; then 
			cp "$1" ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64
			vettrom
		fi
		if [ ! -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64 ]; then
			if [ -f "$BASEPATH"/sm64pc/baserom."$VERSION".z64 ]; then
				cp "$BASEPATH"/sm64pc/baserom."$VERSION".z64 ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc
				vettrom
			fi
			if [ -f "$BASEPATH"/sm64ex/baserom."$VERSION".z64 ] && [ ! -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64 ]; then
				cp "$BASEPATH"/sm64ex/baserom."$VERSION".z64 ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc
				vettrom
			fi
			if [ -f "$BASEPATH"/sm64-port/baserom."$VERSION".z64 ] && [ ! -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64 ]; then
				cp "$BASEPATH"/sm64-port/baserom."$VERSION".z64 ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc
			vettrom
			fi
		fi
		if [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64 ]; then
			echo ROM Found and Verified.
		elif [ -f "$1" ]; then
			xdg-open https://hack64.net/tools/swapper.php &disown
			sleep 1
			exec 2> >(grep -v GtkDialog >&2) # Supress GTK Dialog Warnings
			zenity --error --text='ERROR: Your ROM is not valid.\n\nAn original Super Mario 64 ROM in z64 (big endian) format is required to build.\nIf your rom is backed up in v64 or n64 format, try this online converter then run smlinux again.' --title="Your installation is incomplete." --width=640 &disown	
			sleep 1			
			echo
			echo "ERROR: Your ROM is not valid.  Not even considering transient parents!"
			echo "Original Super Mario 64 ROM image in z64 big endian format is required to build."
			echo If ROM is in v64/n64 format, try this online converter then run smlinux again.
		elif [ "$1" = "update" ] || [ "$1" = "build" ]; then
			echo ERROR: ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64 not found.
			echo
			echo smlinux exiting incomplete.
			echo
			exit
		else	
			echo WARNING: No ROM file found.  Please specify a romfile when you are ready to build.
		fi
	fi
	echo
	if [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64config.txt ] || [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/CHEATERex_config.txt ]; then
		echo Configuration file already exists from previous build.
	elif [ "$REPO" = "sm64-port" ] || [ "$REPO" = "sm64nx" ] || [ ! -d ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO" ]; then
		echo No compatible config files for this version, game will create one.
	elif [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64ex/sm64config.txt ]; then
		cp ${XDG_DATA_HOME:-$HOME/.local/share}/sm64ex/sm64config.txt ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"
		echo Copied configuration from sm64ex.
	elif [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/sm64config.txt ]; then
		cp ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/sm64config.txt ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"
		echo Copied configuration from sm64pc.
	elif [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/render96ex/sm64config.txt ]; then
		cp ${XDG_DATA_HOME:-$HOME/.local/share}/render96ex/sm64config.txt ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"
		echo Copied configuration from render96ex
	elif [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64ex-coop/sm64config.txt ]; then
		cp ${XDG_DATA_HOME:-$HOME/.local/share}/sm64ex-coop/sm64config.txt ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"
		echo Copied configuration from sm64ex-coop
	elif [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/cheaterex/CHEATERex_config.txt ]; then
		cp ${XDG_DATA_HOME:-$HOME/.local/share}/cheaterex/CHEATERex_config.txt ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64config.txt
		echo Copied configuration from CHEATERex
	else
		echo No compatible configuration file found, game will create one.
	fi
	if [ "$REPO" = "cheaterex" ] && [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64config.txt ]; then
		mv ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64config.txt ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/CHEATERex_config.txt
	fi
	if [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64_save_file.bin ] || [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/CHEATERex_save_file.bin ] || [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64.sav ]; then
		echo Save file already exists from previous build.
	elif [ ! -d ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO" ] || [ "TEXTSAVES" = 1 ]; then
		echo No compatible save files for this version.
	elif [ "$REPO" = "sm64-port" ] && [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64nx/sm64.sav ]; then
		cp ${XDG_DATA_HOME:-$HOME/.local/share}/sm64nx/sm64.sav ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64_save_file.bin
		echo Copied save file from sm64nx.
	elif [ "$REPO" = "sm64nx" ] && [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64-port/sm64_save_file.bin ]; then
		cp ${XDG_DATA_HOME:-$HOME/.local/share}/sm64-port/sm64_save_file.bin ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64.sav
		echo Copied save file from sm64-port.
	elif [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64ex/sm64_save_file.bin ]; then
		cp ${XDG_DATA_HOME:-$HOME/.local/share}/sm64ex/sm64_save_file.bin ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"
		echo Copied save file from sm64ex.
	elif [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64-port/sm64_save_file.bin ]; then
		cp ${XDG_DATA_HOME:-$HOME/.local/share}/sm64-port/sm64_save_file.bin ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"
		echo Copied save file from sm64-port.
	elif [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/sm64_save_file.bin ]; then
		cp ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/sm64_save_file.bin ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"
		echo Copied save file from sm64pc.
	elif [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/cheaterex/CHEATERex_save_file.bin ]; then
		cp ${XDG_DATA_HOME:-$HOME/.local/share}/cheaterex/CHEATERex_save_file.bin ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64_save_file.bin
		echo Copied save file from cheaterex
	elif [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64nx/sm64.sav ]; then
		cp ${XDG_DATA_HOME:-$HOME/.local/share}/sm64nx/sm64.sav ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64_save_file.bin
		echo Copied save file from sm64nx.
	else
		No compatible save file found.
	fi
	if [ "$REPO" = "cheaterex" ] && [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64_save_file.bin ]; then
		mv ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64_save_file.bin ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/CHEATERex_save_file.bin
	fi
else
	loadconfig "$@"
fi

if [ "$1" = "--purge" ] || [ "$1" = "purge" ]; then
	
	echo Wiping...
	rm -rf "$BASEPATH"/sm64pc
	rm -rf "$BASEPATH"/sm64ex
	rm -rf "$BASEPATH"/sm64-port
	rm -rf "$BASEPATH"/sm64nx
	rm -rf "$BASEPATH"/render96ex
	rm -rf "$BASEPATH"/cheaterex
	rm -rf "$BASEPATH"/sm64ex-coop
	rm -rf "$BASEPATH"/sm64-port-android.base
	rm -rf "$BASEPATH"/sm64pc.old
	rm -rf "$BASEPATH"/sm64ex.old
	rm -rf "$BASEPATH"/sm64-port.old
	rm -rf "$BASEPATH"/sm64nx.old
	rm -rf "$BASEPATH"/render96ex.old
	rm -rf "$BASEPATH"/cheaterex.old
	rm -rf "$BASEPATH"/sm64ex-coop.old
	rm -rf "$BASEPATH"/sm64-port-android.base.old
	rm -rf ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc
	rm -rf ${XDG_DATA_HOME:-$HOME/.local/share}/sm64ex	
	rm -rf ${XDG_DATA_HOME:-$HOME/.local/share}/sm64-port
	rm -rf ${XDG_DATA_HOME:-$HOME/.local/share}/sm64nx
	rm -rf ${XDG_DATA_HOME:-$HOME/.local/share}/render96ex
	rm -rf ${XDG_DATA_HOME:-$HOME/.local/share}/cheaterex
	rm -rf ${XDG_DATA_HOME:-$HOME/.local/share}/sm64ex-coop
	rm ${XDG_DATA_HOME:-$HOME/.local/share}/icons/sm64*
	rm ${XDG_DATA_HOME:-$HOME/.local/share}/icons/render96ex*
	rm ${XDG_DATA_HOME:-$HOME/.local/share}/icons/cheaterex*
	rm ${XDG_DATA_HOME:-$HOME/.local/share}/applications/sm64*
	rm ${XDG_DATA_HOME:-$HOME/.local/share}/applications/render96ex*
	rm ${XDG_DATA_HOME:-$HOME/.local/share}/applications/cheaterex*
	rm ${XDG_DESKTOP_DIR:-$HOME/Desktop}/sm64*.desktop
	rm ${XDG_DESKTOP_DIR:-$HOME/Desktop}/render96ex*.desktop
	rm ${XDG_DESKTOP_DIR:-$HOME/Desktop}/cheaterex*.desktop
	rm $HOME/Downloads/smlinux.*
	echo Note this did not remove any packages installed as build tools or dependencies.
	echo Remove those with your package manager.  Devel libraries can always safely be removed.
	echo And of course you must delete smlinux itself from "${MAPFILE[0]}"
        exit
fi

if [ -f "$1" ] || [ -f "$LAUNCH_DIR"/"$1" ] || ( [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64 ] && ( [ "$1" = "build" ] || [ "$1" = "update" ]  )); then
	echo
	if [ -f ~/.smlinuxUpdate ]; then 
		rm ~/.smlinuxUpdate
		echo Script Update Complete.
	else	# Fresh Build
		if [ ! -d ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/.git ] || [ "$DEPENDS" = 1 ]; then
			echo "[1] Installing required build tools..."
			if [ -f /usr/bin/apt ]; then
				sudo apt update
			fi
			$Linux
			if [ "$REPO" = "sm64nx" ] ; then
				pip3 install pillow zstandard tqdm xxhash
				gcccheck
			fi
			if [ "$ANDROID" = 1 ]; then
				androidsdk
			fi
			if [ "$TARGET_WEB" = 1 ]; then
				loademsdk
			fi
		elif [ "$REPO" = "sm64nx" ] && [ ! -d "$BASEPATH"/"$REPO/build" ]; then
			echo "[1] Installing required build tools for nx..."
			pip3 install pillow zstandard tqdm xxhash
			gcccheck
		elif [ "$ANDROID" = 1 ]; then
			echo "[1] Loading Android SDK Environment..."
			androidsdk
		elif [ "$TARGET_WEB" = 1 ]; then
			echo "[1] Loading Enscriptem for Web Target..."
			loademsdk
		else
			echo "[1] This is not first build, skipping dependencies..."
		fi
		echo
		echo [2] Checking Github for smlinux updates....
		if [ "$AutoUpdate" = 1 ]; then
			scriptUpdate "$@"
		else
			echo "WARNING: AutoUpdate Disabled in Config File! You might be using an old version!"
		fi
	fi
else
	echo "/-----------------------------------------------------------------------------\\"
	echo "|                                                                             |"
	echo "|      Super Mario 64 Install * Build * Update Script for Linux               |"
	echo "|                                                                             |"
	echo "| Installation & First Build: ./smlinux <romfile>                             |"
	echo "|  for example:                                                               |"
	echo "|   ./smlinux ~/roms/n64/sm64.z64  or  ./smlinux \"Super Mario 64 (U) [!].z64\" |"
	echo "|                                                                             |"
	echo "| Normal Usage: smlinux <command> <options>                                   |"
	echo "|                                                                             |"
	echo "| Commands:                                                                   |"
	echo "|  update: Updates source & rebuilds, preserving mods and external resources  |"
	echo "|  build:  Gets new source from github and builds. (Renames existing folder)  |"
	echo "|  config: Opens smlinuxcfg.txt in text editor without building               |"
	echo "|  reset:  Resets smlinux configuration file to default settings              |"
	echo "|  purge:  Removes all files created by this script, including sm64           |"
	echo "|                                                                             |"
	echo "| Options: --depends  reinstall dependencies                                  |"
	echo "|          --config   prompt to edit configuration file before build          |"
	echo "|          --hd       aquire & apply upscale enhancements (see FAQ)           |"
	echo "|          --sgi      aquire and apply Render96 SGI model pack v1.3           |"
	echo "|                                                                             |"
	echo "-------------------------------------------------------------------------------"
	if [ "$1" = "--help" ] || [ "$1" = "-help" ] || [ "$1" = "help" ] || [ "$1" = "-h" ]; then
		exit
	elif [ -f ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64 ]; then
		echo "ERROR: You must specify update, build, config or purge."
	else 
		echo "ERROR: Must provide valid path/filename to Z64 formatted romfile."	
	fi
	exit
fi
if [ "$1" = "-u" ] || [ "$1" = "--update" ] || [ "$1" = "update" ] || [ "$1" = "up" ]; then
	if [ ! -d "$BASEPATH"/"$REPO" ]; then
		echo
		echo ERROR: No "$BASEPATH"/"$REPO" folder to update!
		echo Specify smlinux build for a fresh build.
		exit
	fi
	echo
	echo [3] Checking "$REPO" github repository for updates...
	if [ "$REPO" = "sm64-port-android-base/app/jni/src" ]; then
		cd "$BASEPATH"/"$REPO"/../../..
	else
		cd "$BASEPATH"/"$REPO"
	fi
	echo
	git fetch
	git checkout "$BRANCH"
	if [ "$(git diff HEAD origin/HEAD)" != "" ]; then
		 git merge
	fi
	if [ "$?" = "1" ]; then
		cd "$BASEPATH"/"$REPO"
		if [ -f "$BASEPATH"/"$REPO"/enhancements/3d_coin*.patch ]; then
			git apply -R enhancements/3d_coin*.patch
		fi
		if [ -f "$BASEPATH"/"$REPO"/enhancements/60fps ]; then
			git apply -R enhancements/60fps*.patch
		fi
		if [ -f "$BASEPATH"/"$REPO"/enhancements/CHEATER*.patch ]; then
			git apply -R enhancements/CHEATER*.patch
		fi
		if [ -f "$BASEPATH"/"$REPO"/enhancements/menu-arrows.patch ]; then
			git apply -R enhancements/menu-arrows.patch
		fi
		git merge
		if [ "$?" = "1" ]; then
			echo WARNING: Unable to merge source updates from github.
		fi
		if [ -f "$BASEPATH"/"$REPO"/enhancements/3d_coin*.patch ]; then
			git apply enhancements/3d_coin*.patch
		fi
		if [ -f "$BASEPATH"/"$REPO"/enhancements/60fps ]; then
			git apply enhancements/60fps*.patch
		fi
		if [ -f "$BASEPATH"/"$REPO"/enhancements/CHEATER*.patch ]; then
			git apply enhancements/CHEATER*.patch
		fi
		if [ -f "$BASEPATH"/"$REPO"/enhancements/menu-arrows.patch ]; then
			git apply enhancements/menu-arrows.patch
		fi
	fi
	if [ "$REPO" = "sm64-port-android-base/app/jni/src" ]; then
		git submodule init
		git submodule update	
		if [ -d "$BASEPATH"/"$REPO"/../../build ]; then
			rm -rf "$BASEPATH"/"$REPO"/../../build
			rm -rf "$BASEPATH"/"$REPO"/../../.externalNativeBuild
		fi
	fi
	echo
	echo [4] Applying pre-build modifications...
	if [ "$UpdateHD" = 1 ] && [ "$InstallHD" = 1 ]; then
		printf "\nUpdating Community Upscale Enhancements...\n\n"
		dohd
	elif [ "$SGI" = 1 ]; then
		printf "\nSGI Selected, Processing...\n\n"
		dosgi
	fi
	if ([ "$REPO" = "sm64ex" ] && [ "$BRANCH" = "nightly" ] ) || [ "$BRANCH" = "sm64ex_nightly" ] || [ "$REPO" = "render96ex" ] ; then
		cd "$BASEPATH"/"$REPO"
		if [ -f "$BASEPATH"/"$REPO"/enhancements/CHEATER*.patch ]; then
			git apply -R enhancements/CHEATER*.patch
			rm enhancements/CHEATER*
		fi
		cd enhancements
		wget -q https://cdn.discordapp.com/attachments/716459185230970880/750380998373671012/CHEATER.zip
		unzip CHEATER*
		rm CHEATER.zip
		cd ..
		echo Applying latest cheats...
		git apply enhancements/CHEATER.patch
		if [ ! -f "$BASEPATH"/"$REPO"/enhancements/menu-arrows.patch ]; then
			cp ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/menu-arrows.patch enhancements
			echo Applying Menu Arrows...
			git apply enhancements/menu-arrows.patch
		fi
	fi
	if [ "TARGET_WEB" = 1 ] && [ -f "$BASEPATH"/"$REPO"/enhancements/60fps ]; then
		git apply -R enhancements/60fps*.patch
		rm enhanements/60fps			
	fi
	echo		
	echo [5] Compiling...
	if [ -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET" ]; then
		if [ -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET".old ]; then
			rm -rf "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET".old
		fi
		mv "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET" "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET".old
	fi
	domake
	echo
	if [ ! -f "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/sm64."$VERSION".f3dex2* ]; then
		echo "ERROR: Build Failure - output file not found."  
		if [ -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET".old ]; then
			echo "Restoring previous build..."
			if [ -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET" ]; then 
				rm -rf "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET" 
			fi
			mv "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET".old "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"
		fi
		echo "smlinux exiting incomplete.  Contact #help-desk for support."
		xdg-open https://discord.gg/Ub6YHRm &disown
		exit
	fi
	if [ -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET".old/res ]; then
		echo [6] Restoring External Resources...
		cp -rpn "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET".old/res/. "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res
	elif [ -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET".old/romfs ]; then
		echo "[6] Restoring Savefile, ROM and ROM Filesystem (paks)"
		cp -rpn "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET".old/romfs/. "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/romfs
		ln -s ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64.sav "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/sm64.sav 
		ln -s ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/sm64.log "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/sm64.log 
		ln -s ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/conf.bin "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/conf.bin
	 	ln -s ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/gamepad1.bindings.json "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/gamepad1.bindings.json
		ln -s ${XDG_DATA_HOME:-$HOME/.local/share}/"$REPO"/keyboard1.bindings.json "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/keyboard1.bindings.json
		ln -s ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64 "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/baserom."$VERSION".z64
	elif [ "$REPO" = "sm64nx" ]; then
		echo "[6] Preparing Savefile, ROM and ROM Filesystem (paks)"
		prepnx
		if [ "$InstallHD" = 1 ]; then
			dohd
		fi		
	else
		echo [6] No resources found in previous build, skipping restore...
	fi
	if [ "$ANDROID" = 1 ] && [ -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res/gfx ]; then
		cd "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/res
		zip -r -0 -u hdbase gfx
		rm -rf gfx
	fi
	echo
	if [ "$TARGET" = "web" ]; then
		echo [7] Update Complete.  Testing Application...
	elif [ "$ANDROID" = 1 ] && [ ! -f "$BASEPATH"/"$REPO"/../../build/outputs/apk/debug/app-debug.apk ]; then
		echo
		echo "ERROR: Build Failure.  Android Package Kit (apk) not found."
		echo "smlinux exiting incomplete.  Contact #help-desk for support."
		xdg-open https://discord.gg/Ub6YHRm &disown
		exit
	elif [ ! "$ANDROID" = 1 ] ; then
		echo [7] Creating Menu Entry and Desktop Shortcut....
		makedesktop
		echo
		echo [8] Update Complete.  Testing Application...
	elif [ "$ANDROID" = 1 ]; then
		mv "$BASEPATH"/"$REPO"/../../build/outputs/apk/debug/app-debug.apk "$BASEPATH"/"$REPO"/../../build/outputs/apk/debug/sm64."$VERSION".f3dex2e.apk
		echo [7] Update Complete. 
	fi
	rungame
	sleep 10
	echo
	echo smlinux is complete.  You may exit or close this terminal window.
	if [ "$TARGET" = "web" ]; then
		echo Python Webserver will remain running until it is closed.
	fi
	echo
	exit
fi
echo
echo [3] Downloading "$REPO" source from github... 
echo
if [ -d "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET" ]; then
	if [ "$REPO" = "sm64-port-android-base/app/jni/src" ]; then
		echo WARNING: sm64-port-android-base directory already exists! 
		echo Renaming to sm64-port-android-base.old...
		if [ -d "$BASEPATH"/sm64-port-android-base.old ]; then
			rm -rf "$BASEPATH"/sm64-port-android-base.old
		fi
		mv "$BASEPATH"/sm64-port-android-base "$BASEPATH"/sm64-port-android-base.old
	else
		echo WARNING: "$REPO" directory already exists!  Renaming to "$REPO".old...
		if [ -d "$BASEPATH"/"$REPO".old ]; then
			rm -rf "$BASEPATH"/"$REPO".old
		fi
		mv "$BASEPATH"/"$REPO" "$BASEPATH"/"$REPO".old
	fi
fi
if [ ! -d "$BASEPATH"/"$REPO" ]; then
	cd "$BASEPATH"
	if [ "$REPO" = "sm64nx" ]; then
		git clone https://github.com/teamsalta/"$REPO" -b "$BRANCH"
	elif [ "$REPO" = "sm64ex" ]; then
		git clone https://github.com/sm64pc/"$REPO" -b "$BRANCH"
	elif [ "$REPO" = "sm64-port-android-base/app/jni/src" ]; then
		git clone https://github.com/vdavid003/sm64-port-android-base -b "$BRANCH"
		cd sm64-port-android-base
		git submodule init
		git submodule update
		./getSDL.sh
	elif [ "$REPO" = "render96ex" ]; then
		git clone https://github.com/render96/"$REPO" -b "$BRANCH"
	elif [ "$REPO" = "sm64ex-coop" ]; then
		git clone https://github.com/djoslin0/sm64ex-coop -b "$BRANCH"
	elif [ "$REPO" = "cheaterex" ]; then
		git clone https://github.com/s4Ys369/cheaterex -b "$BRANCH"
	else
		git clone https://github.com/"$REPO"/"$REPO" -b "$BRANCH"
	fi
fi
if [ ! -d "$BASEPATH"/"$REPO" ]; then
	echo "ERROR: Could not reach github."
	echo "Script Ending Incomplete.  Contact #help-desk for support."
	xdg-open https://discord.gg/Ub6YHRm &disown
	exit
fi
ln -s ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/baserom."$VERSION".z64 "$BASEPATH"/"$REPO"/baserom."$VERSION".z64

echo
echo [4] Extracting Assets from ROM...
echo
if [ "$REPO" = "sm64nx" ]; then
	prepnx
else 	
	cd "$BASEPATH"/"$REPO"
	./extract_assets.py "$VERSION"
fi

echo
echo [5] Applying Community Enhancements...
echo

if [ "$InstallHD" = 1 ]; then 
	dohd
elif [ "$SGI" = 1 ]; then
	dosgi
else
	echo "WARNING: InstallHD Disabled in Config File."
fi
if  [ "$REPO" = "sm64ex" ] || [ "$BRANCH" = "sm64ex_nightly" ] || [ "$BRANCH" = "sm64ex" ] || [ "$REPO" = "render96ex" ] || [ "$REPO" = "sm64ex-coop" ]; then 
	cd "$BASEPATH"/"$REPO"/enhancements
	cp ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/menu-arrows.patch .
	if [ ! "$REPO" = "sm64ex-coop" ]; then
		wget -q https://cdn.discordapp.com/attachments/716459185230970880/750380998373671012/CHEATER.zip
		unzip CHEATER
		rm CHEATER.zip
	else
		wget -q https://cdn.discordapp.com/attachments/710283360794181633/752941642671194205/CHEATER-coop.v.1.hotfix.patch
	fi
	cd "$BASEPATH"/"$REPO"
	echo Appling Cheats...
	git apply enhancements/CHEATER*.patch
	echo Applying Menu Arrows...
	git apply enhancements/menu-arrows.patch
fi
if [ "$BRANCH" = "sm64ex_nightly" ] && [ ! "$TOUCH_CONTROLS" = 1 ]; then
	cd "$BASEPATH"/"$REPO"
	cp ${XDG_DATA_HOME:-$HOME/.local/share}/sm64pc/pro1.patch enhancements
	echo "Applying Pro¹ Configuration File..."
	git apply enhancements/pro1.patch
fi
echo
echo [6] Compiling...
echo
domake
if [ ! -f "$BASEPATH"/"$REPO"/build/"$VERSION"_"$TARGET"/sm64."$VERSION".f3dex2* ]; then
	echo
	echo ERROR: Build Failure.  Expected binary file not found.
	echo "smlinux exiting incomplete.  Contact #help-desk for support."
	xdg-open https://discord.gg/Ub6YHRm &disown
	exit
fi
if [ "$ANDROID" = 1 ] && [ ! -f "$BASEPATH"/"$REPO"/../../build/outputs/apk/debug/app-debug.apk ]; then
	echo
	echo ERROR: Build Failure.  Expected apk file not found.
	echo "smlinux exiting incomplete.  Contact #help-desk for support."
	xdg-open https://discord.gg/Ub6YHRm &disown
	exit
elif [ -f "$BASEPATH"/"$REPO"/../../build/outputs/apk/debug/app-debug.apk ]; then
	mv "$BASEPATH"/"$REPO"/../../build/outputs/apk/debug/app-debug.apk "$BASEPATH"/"$REPO"/../../build/outputs/apk/debug/sm64."$VERSION".f3dex2e.apk
fi
echo
if [ "$TARGET_WEB" = 1 ] || [ "$ANDROID" = 1 ]; then
	echo [7] Skipping menu entry for non pc version...
else
	echo [7] Creating Desktop Shortcut and Menu Entry...
	makedesktop
fi
echo
echo [8] Build Succesful!  Testing Application Launch...
echo
rungame
if [ -f "$BASEPATH"/.smlinuxNopath ]; then
	rm "$BASEPATH"/.smlinuxNopath
	exec 2> >(grep -v GtkDialog >&2) # Supress GTK Dialog Warnings
	zenity --info --text='You did not have a home folder in your path so $HOME/bin was created.\n\nReboot or type \n\n    PATH=$HOME/bin:$PATH\n\nbefore running smlinux again.' --title="Your installation is complete." --width=450	
	printf '\nYou did not have a home folder in your path so $HOME/bin was created.\n\nReboot or type \n\n      PATH=$HOME/bin:$PATH\n\nbefore running smlinux again.\n\n'
else	
	sleep 10
fi
echo
echo smlinux is complete.  You may exit or close this terminal window.
if [ "$TARGET_WEB" = 1 ]; then
	echo Python Webserver will remain running until it is closed.
fi
echo